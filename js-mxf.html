<!DOCTYPE html>
<html lang="en-US" prefix="og: https://ogp.me/ns#">
    <head>
        <meta charset="utf-8">
    </head>
<body>

<script>
// https://stackoverflow.com/questions/40031688/javascript-arraybuffer-to-hex/50767210#50767210
function to_hex(buffer) {
    return [...new Uint8Array (buffer)]
        .map (b => b.toString (16).padStart (2, "0"))
        .join ("");
}
function to_dec(buffer) {
    return parseInt(buffer, 16);
}
function getUUID(buffer) {
    return to_hex(
        buffer
    ).toUpperCase();
}
function getSize(buffer) {
    /*
    The length field is always coded MSB (most significant byte) first
    40h                          short form coded
    83.00.00.40                  long form coding using 4 bytes overall
    87.00.00.00.00.00.00.40      long form coding using 8 bytes overall
    */
    ber_code = buffer.slice(0, 1); 
    ber_value = buffer.slice(1, 4);
    size = to_dec(to_hex(ber_value));
    return size;
}

function dropHandler(evt) {
    evt.stopPropagation();
    evt.preventDefault();

    var files = evt.dataTransfer.files;
    var file = files[0];

    var loop = 0;

    var offset = 0;
    var size = 20;

    var data_offset = 0;
    var data_size = 0;

    var readEventHandlerData = function(event) {
        console.log(klv_uuid, "data=", event.target.result.byteLength);
    }

    var readEventHandler = function(event) {
        klv_uuid = getUUID(event.target.result.slice(0, 16));
        klv_size = getSize(event.target.result.slice(16, 20));
        
        console.log(klv_uuid, "offset=", offset, "klv_size=", klv_size, "size=", klv_size+20);
        readChunkData(file, offset, klv_size+20);

        if (!klv_uuid) {
            console.log("stop");
            return;
        }
        
        size = klv_size;
        offset += (20 + klv_size);

        readChunk(file, offset, size);
    }


    function readChunk(fileHandler, offset, size) {
        var reader = new FileReader();
        var chunk = fileHandler.slice(offset, offset + size);
        reader.onload = readEventHandler;
        reader.readAsArrayBuffer(chunk);
    }
    function readChunkData(fileHandler, _offset, _size) {
        var reader = new FileReader();
        var chunk = fileHandler.slice(_offset, _offset + _size);
        data_offset = _offset;
        data_size = _size;
        reader.onload = readEventHandlerData;
        reader.readAsArrayBuffer(chunk);
    }

    // Read the first KLV
    readChunk(file, offset, size);

}

function dragoverHandler(evt) {
    evt.stopPropagation();
    evt.preventDefault();
    evt.dataTransfer.dropEffect = 'copy';
}
</script>

<style>
#drop {
    border:1px solid blue;
    height:50px;
    width:100%;
}
</style>

<div id="drop" ondragover="dragoverHandler(event)" ondrop="dropHandler(event)">
    Drop your MXF here
</div>

</body>
</html>
